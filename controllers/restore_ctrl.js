var csv=require("csvtojson"),clients=require("../clients.js");exports.import=async(req,res,next)=>{try{var c,file=req.files.file,data=await csv().fromFile(file.tempFilePath);let count=0,skipped=0;for(c of data){var username=c.Username||c.username,password=c.Password||c.password;if(username&&password){var ip_address=c["IP Address"]||c["ip address"]||c["Ip Address"],max_download=parseInt(c["Max Download"]||c.Download||c.download||(c.Max||[])[" Download"]||0),max_upload=parseInt(c["Max Upload"]||c.Upload||c.upload||(c.Max||[])[" Upload"]||0),started_at=c["Start Time"]||c["Start time"];let attrs={username:username,password:password,ip_address:ip_address,max_download:max_download,max_upload:max_upload,auto_bill:!!String(c["Auto-bill?"]||c["Auto bill"]||c["auto bill"]).match(/yes|true/i),billing_phone_number:c["Billing Phone Number"]||c["billing phone number"]||"",billing_date:c["Billing Date"]||c["bill date"]||"",billing_due_date:c["Billing Due Date"]||c["billing due date"]||"",billing_amount:c["Billing Amount"]||c["billing amount"]||""};started_at&&(attrs.started_at=started_at);let exp_date=new Date(c.Expiration);var exp_time=String(c.Expiration).split(":");if(0<exp_date.getTime())attrs.expiration_date=exp_date;else if(3<=exp_time.length){let t=0;for(let i=0;i<exp_time.length;i++){var v=parseInt(exp_time[exp_time.length-(1+i)]);if(0<v)switch(i){case 0:t+=parseInt(v/60);break;case 1:t+=v;break;case 2:t+=60*v;break;case 3:t+=24*v*60}}0<t&&(attrs.expire_minutes=t)}try{await clients.createClient(attrs),count++}catch(e){skipped++}}else skipped++}res.json({count:count,skipped:skipped})}catch(e){next(e)}};